<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>äº•å­—æ£‹"æ®µä½"æŒ‘æˆ˜</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(to bottom right, #f0f4f8, #d9e2ec);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        color: #4a5568;
      }

      .game-container {
        text-align: center;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
        width: 500px;
        box-sizing: border-box;
      }

      h1 {
        color: #2b3e50;
        margin-bottom: 15px;
        font-size: 2.2em;
      }

      .controls {
        margin-bottom: 15px;
      }

      .difficulty-selector {
        margin-bottom: 10px;
      }

      .difficulty-selector label {
        display: inline-block;
        width: 80px;
        text-align: left;
      }

      .status {
        font-size: 1.4em;
        margin: 15px 0;
        min-height: 1.5em;
        font-weight: bold;
        color: #334e68;
      }

      .game-info {
        display: flex;
        justify-content: space-around;
        margin: 15px 0;
        padding: 10px;
        background-color: #f7fafc;
        border-radius: 8px;
      }

      .info-item {
        text-align: center;
      }

      .info-label {
        font-size: 0.9em;
        color: #718096;
        margin-bottom: 5px;
      }

      .info-value {
        font-size: 1.3em;
        font-weight: bold;
        color: #2b3e50;
      }

      .timer {
        font-size: 1.2em;
        color: #e53e3e;
        font-weight: bold;
        margin: 10px 0;
        min-height: 1.5em;
      }

      .timer.warning {
        color: #f56565;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .rank-display {
        font-size: 1.8em;
        color: #4299e1;
        font-weight: bold;
        margin: 20px 0;
        padding: 15px;
        background-color: #ebf8ff;
        border-radius: 8px;
        border: 2px solid #4299e1;
      }

      /* å³ä¾§ç”¨æ—¶è®°å½•é¢æ¿æ ·å¼ */
      .log-panel {
        position: fixed;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        width: 260px;
        max-height: 95vh;
        /* min-height: 320px; */
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 16px 18px;
        box-sizing: border-box;
        font-size: 0.9em;
        color: #2d3748;
        overflow-y: auto;
        z-index: 10;
      }

      .log-title {
        font-weight: bold;
        font-size: 1.1em;
        color: #2b3e50;
        margin-bottom: 8px;
      }

      .log-subtitle {
        font-size: 0.8em;
        color: #718096;
        margin-bottom: 10px;
      }

      .log-game-header {
        margin-top: 10px;
        margin-bottom: 4px;
        font-weight: bold;
        color: #3182ce;
      }

      .log-entry {
        padding: 8px 10px;
        border-radius: 8px;
        background-color: #f7fafc;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
        line-height: 1.4;
      }

      .log-entry:last-child {
        margin-bottom: 0;
      }

      .entry-meta {
        font-size: 0.85em;
        color: #718096;
        margin-bottom: 4px;
      }

      .entry-body {
        font-weight: bold;
        color: #2d3748;
      }

      .entry-time {
        font-size: 0.85em;
        color: #805ad5;
        margin-top: 2px;
      }

      .entry-bar-wrapper {
        margin-top: 4px;
        height: 6px;
        background-color: #edf2f7;
        border-radius: 999px;
        overflow: hidden;
      }

      .entry-bar {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #63b3ed, #805ad5);
        width: 0;
        transition: width 0.4s ease-out;
      }

      /* çªå‡ºæ˜¾ç¤º AI æ€è€ƒæ—¶é—´åŒºåŸŸ */
      #thinking-time {
        display: none; /* é»˜è®¤ä¸æ˜¾ç¤ºï¼Œé¿å…ä¸€å¼€å§‹å‡ºç°ç©ºæ¡† */
        font-size: 1.1em;
        color: #805ad5;
        font-weight: bold;
        background-color: #faf5ff;
        border-radius: 6px;
        padding: 6px 10px;
        border: 1px dashed #b794f4;
        margin-top: 4px;
        min-height: 1.4em;
      }

      .thinking-active {
        animation: thinkingPulse 0.8s infinite;
      }

      @keyframes thinkingPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(128, 90, 213, 0.6);
        }
        70% {
          box-shadow: 0 0 0 8px rgba(128, 90, 213, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(128, 90, 213, 0);
        }
      }

      .board {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 10px;
        margin: 20px auto;
        max-width: 300px;
      }

      .cell {
        width: 90px;
        height: 90px;
        background-color: #edf2f7;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2.5em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .cell.disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .cell:hover {
        background-color: #e2e8f0;
      }

      .cell.x {
        color: #e53e3e; /* çº¢è‰² */
      }

      .cell.o {
        color: #3182ce; /* è“è‰² */
      }

      button {
        background-color: #4299e1;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 1.1em;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #3182ce;
      }

      .thinking {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .questions-section {
        margin-top: 30px;
        padding: 20px;
        background-color: #f7fafc;
        border-radius: 8px;
        text-align: left;
      }

      .questions-section h3 {
        color: #2b3e50;
        margin-bottom: 15px;
        border-bottom: 2px solid #4299e1;
        padding-bottom: 5px;
      }

      .question {
        margin-bottom: 20px;
      }

      .question p {
        font-weight: bold;
        color: #4a5568;
        margin-bottom: 8px;
      }

      .answer-box {
        width: 100%;
        min-height: 60px;
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.95em;
        resize: vertical;
        box-sizing: border-box;
      }

      .answer-box:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="game-container">
        <h1>äº•å­—æ£‹"æ®µä½"æŒ‘æˆ˜</h1>
        <div class="game-info">
          <div class="info-item">
            <div class="info-label">å½“å‰æ®µä½</div>
            <div class="info-value" id="current-difficulty">0</div>
          </div>
          <div class="info-item">
            <div class="info-label">å‰©ä½™æœºä¼š</div>
            <div class="info-value" id="remaining-chances">â¤ï¸â¤ï¸â¤ï¸</div>
          </div>
        </div>
        <div class="status" id="status">è¯·ç‚¹å‡»â€œå¼€å§‹æŒ‘æˆ˜â€æŒ‰é’®å¼€å§‹æ¸¸æˆ</div>
        <div class="timer" id="timer"></div>
        <button id="start-game">å¼€å§‹æŒ‘æˆ˜</button>
        <div
          class="status"
          id="thinking-time"
        ></div>
        <div class="rank-display" id="rank-display" style="display: none;"></div>
        <div class="board" id="board">
          <div class="cell" data-index="0"></div>
          <div class="cell" data-index="1"></div>
          <div class="cell" data-index="2"></div>
          <div class="cell" data-index="3"></div>
          <div class="cell" data-index="4"></div>
          <div class="cell" data-index="5"></div>
          <div class="cell" data-index="6"></div>
          <div class="cell" data-index="7"></div>
          <div class="cell" data-index="8"></div>
        </div>
        <button id="next-challenge" style="display: none;">ä¸‹ä¸€å±€æŒ‘æˆ˜</button>
      </div>

      <div class="log-panel" id="log-panel">
        <div class="log-title">AI æ€è€ƒç”¨æ—¶è®°å½•</div>
        <!-- åŠ¨æ€æ—¥å¿—å†…å®¹æ’å…¥åˆ°è¿™é‡Œ -->
      </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const boardElement = document.getElementById("board");
        const statusElement = document.getElementById("status");
        const startButton = document.getElementById("start-game");
        const nextChallengeButton = document.getElementById("next-challenge");
        const currentDifficultyElement = document.getElementById("current-difficulty");
        const remainingChancesElement = document.getElementById("remaining-chances");
        const timerElement = document.getElementById("timer");
        const rankDisplayElement = document.getElementById("rank-display");
        const logPanelElement = document.getElementById("log-panel");

        let board = ["", "", "", "", "", "", "", "", ""];
        let currentPlayer = "X"; // X is human, O is AI
        let gameActive = false; // åˆå§‹ä¸æ¿€æ´»ï¼Œç­‰å¾…ç‚¹å‡»â€œå¼€å§‹æŒ‘æˆ˜â€
        let gameStarted = false; // æ ‡è®°æ˜¯å¦å·²ç»ç‚¹å‡»è¿‡å¼€å§‹
        let gameIndex = 0; // å½“å‰æ˜¯ç¬¬å‡ å±€
        let moveNumber = 0; // å½“å‰å±€ä¸­ç¬¬å‡ æ­¥ AI è½å­
        let aiThinking = false;
        let currentDifficulty = 0;
        let remainingChances = 3;
        let timerInterval = null;
        let timeLeft = 30;

        const winningConditions = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8], // è¡Œ
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8], // åˆ—
          [0, 4, 8],
          [2, 4, 6], // å¯¹è§’çº¿
        ];

        function startTimer() {
          clearTimer();
          timeLeft = 30;
          updateTimerDisplay();
          timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
              clearTimer();
              // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨åˆ¤è¾“
              statusElement.textContent = "æ—¶é—´åˆ°ï¼æ‚¨è¾“äº†ï¼";
              gameActive = false;
              disableAllCells();
              handleGameLoss();
            }
          }, 1000);
        }

        function clearTimer() {
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
        }

        function updateTimerDisplay() {
          if (timeLeft <= 10) {
            timerElement.textContent = `å€’è®¡æ—¶: ${timeLeft} ç§’`;
            timerElement.classList.add("warning");
          } else {
            timerElement.textContent = `å€’è®¡æ—¶: ${timeLeft} ç§’`;
            timerElement.classList.remove("warning");
          }
        }

        function handleCellClick(e) {
          if (!gameActive || currentPlayer !== "X" || aiThinking) return;

          const cell = e.target;
          const index = parseInt(cell.getAttribute("data-index"));

          if (board[index] !== "") return;

          // ç«‹å³ç»˜åˆ¶ç©å®¶æ£‹å­
          makeMove(index, "X");
          clearTimer(); // æ¸…é™¤å€’è®¡æ—¶

          // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å› ç©å®¶è½å­è€Œç»“æŸ
          if (checkGameEnd()) return;

          // AIå›åˆ
          currentPlayer = "O";
          statusElement.textContent = "AI æ€è€ƒä¸­...";
          aiThinking = true;

          // æ·»åŠ è¿™ä¸€è¡Œæ¥è·å–æ˜¾ç¤ºæ€è€ƒæ—¶é—´çš„å…ƒç´ 
          const thinkingTimeElement = document.getElementById("thinking-time");
          thinkingTimeElement.textContent = ""; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
          thinkingTimeElement.style.display = "inline-block";
          thinkingTimeElement.classList.add("thinking-active");

          // è®°å½•å¼€å§‹æ—¶é—´
          const startTime = Date.now();

          // å¯åŠ¨å®šæ—¶å™¨æ¥æ›´æ–°æ˜¾ç¤ºçš„æ€è€ƒæ—¶é—´
          const timer = setInterval(() => {
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(3);
            thinkingTimeElement.textContent = `AI æ€è€ƒæ—¶é—´: ${elapsed} ç§’`;
          }, 100); // æ¯100æ¯«ç§’æ›´æ–°ä¸€æ¬¡

          // ä½¿ç”¨setTimeoutè®©UIæœ‰æœºä¼šæ›´æ–°ï¼Œç„¶åæ‰§è¡ŒAIæ€è€ƒ
          // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ‰§è¡Œï¼Œè®©UIå…ˆæ›´æ–°
          requestAnimationFrame(() => {
            setTimeout(() => {
              aiMove();
              aiThinking = false;
              // åœæ­¢è®¡æ—¶å™¨å¹¶æ˜¾ç¤ºæœ€ç»ˆæ—¶é—´
              clearInterval(timer);
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(3);
              thinkingTimeElement.textContent = `ğŸ¤– AI æ€è€ƒæ—¶é—´: ${elapsed} ç§’`;
              thinkingTimeElement.classList.remove("thinking-active");

              // è®°å½•æœ¬æ¬¡ AI è½å­çš„æ€è€ƒæ—¶é—´
              logAiMoveTime(gameIndex, moveNumber + 1, currentDifficulty, elapsed);
              moveNumber++;
              
              // AIä¸‹å®Œåï¼Œå¦‚æœæ˜¯ç©å®¶å›åˆï¼Œå¯åŠ¨å€’è®¡æ—¶
              if (currentPlayer === "X" && gameActive) {
                startTimer();
              }
            }, 10);
          });
        }

        function makeMove(index, player) {
          board[index] = player;
          const cell = document.querySelector(`[data-index="${index}"]`);
          cell.textContent = player;
          cell.classList.add(player.toLowerCase());
        }

        function simulateComputation(depth) {
          // å¤§å¹…å¢åŠ è®¡ç®—è´Ÿè½½ï¼Œè®©å·®å¼‚æ›´æ˜æ˜¾
          // ä½¿ç”¨æŒ‡æ•°å¢é•¿æ¥æ¨¡æ‹Ÿç»„åˆçˆ†ç‚¸ï¼Œä½†é™åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°ä»¥é¿å…æµè§ˆå™¨é•¿æ—¶é—´å¡æ­»
          const maxIterations = 50000000; // é™åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆçº¦5ç§’çš„è®¡ç®—é‡ï¼‰
          const iterations = Math.min(Math.pow(2, depth) * 2000000, maxIterations);

          let result = 0;
          for (let i = 0; i < iterations; i++) {
            result += Math.random(); // æ¨¡æ‹Ÿå®é™…è®¡ç®—
          }
          return result;
        }

        function checkWin(currentBoard) {
          for (let condition of winningConditions) {
            const [a, b, c] = condition;
            if (
              currentBoard[a] &&
              currentBoard[a] === currentBoard[b] &&
              currentBoard[a] === currentBoard[c]
            ) {
              return currentBoard[a];
            }
          }
          return null;
        }

        function checkDraw(currentBoard) {
          return !currentBoard.includes("");
        }

        function handleGameWin() {
          clearTimer();
          statusElement.textContent = "æ­å–œæ‚¨è·èƒœï¼æ®µä½æå‡ï¼";
          // æ®µä½æå‡
          currentDifficulty++;
          remainingChances = 3;
          updateGameInfo();
          nextChallengeButton.style.display = "inline-block";
        }

        function handleGameLoss() {
          clearTimer();
          remainingChances--;
          updateGameInfo();
          
          if (remainingChances <= 0) {
            // 3æ¬¡æœºä¼šç”¨å®Œï¼Œæ˜¾ç¤ºæ®µä½è¯„ä»·
            showRank();
            nextChallengeButton.style.display = "none";
          } else {
            statusElement.textContent = `æ‚¨è¾“äº†ï¼è¿˜æœ‰ ${remainingChances} æ¬¡æœºä¼š`;
            nextChallengeButton.style.display = "inline-block";
          }
        }

        function showRank() {
          rankDisplayElement.style.display = "block";
          rankDisplayElement.innerHTML = `æ‚¨çš„æ®µä½ï¼š${currentDifficulty} æ®µï¼Œè¯·å‰å¾€ <a href="https://www.umu.cn/course/index#/groups/7187322/sessions/57775916/view" target="_blank" rel="noopener noreferrer">UMU å¹³å°</a> å®Œæˆæ´»åŠ¨1é—®å·`;
          statusElement.textContent = "æŒ‘æˆ˜ç»“æŸï¼";
        }

        function formatDifficultyLabel(level) {
          const safeLevel = Math.max(0, level);
          const emoji = safeLevel === 0 ? "ğŸŒ±" : "â­".repeat(safeLevel);
          return `${emoji}ï¼ˆæ®µä½ ${safeLevel}ï¼‰`;
        }

        function updateGameInfo() {
          currentDifficultyElement.textContent = formatDifficultyLabel(
            currentDifficulty
          );
          // ä½¿ç”¨çº¢å¿ƒ emoji æ˜¾ç¤ºå‰©ä½™æœºä¼šï¼Œæ›´ç›´è§‚æœ‰è¶£
          remainingChancesElement.textContent = "â¤ï¸".repeat(
            Math.max(0, remainingChances)
          );
        }

        // è®°å½• AI æ¯ä¸€æ­¥æ€è€ƒæ—¶é—´åˆ°å³ä¾§é¢æ¿
        function logAiMoveTime(gameIdx, moveIdx, difficulty, elapsedSeconds) {
          if (!logPanelElement || gameIdx <= 0) return;
          const entry = document.createElement("div");
          entry.className = "log-entry";
          const difficultyLabel = formatDifficultyLabel(difficulty);
          // ä»¥ 5 ç§’ä¸ºåŸºå‡†ç”Ÿæˆé•¿åº¦æ¡ï¼Œæœ€é•¿ä¸è¶…è¿‡ 100%
          const maxSeconds = 0.5;
          const clamped = Math.min(parseFloat(elapsedSeconds) || 0, maxSeconds);
          const percent = (clamped / maxSeconds) * 100;
          entry.innerHTML = `
            <div class="entry-body">${difficultyLabel}</div>
            <div class="entry-time">â± ${elapsedSeconds} ç§’</div>
            <div class="entry-bar-wrapper">
              <div class="entry-bar" style="width: ${percent}%;"></div>
            </div>
          `;
          logPanelElement.appendChild(entry);
          logPanelElement.scrollTop = logPanelElement.scrollHeight;
        }

        // æ¯ä¸€å±€å¼€å§‹æ—¶æ·»åŠ ä¸€ä¸ªå°æ ‡é¢˜
        function addGameHeader(gameIdx) {
          if (!logPanelElement || gameIdx <= 0) return;
          const header = document.createElement("div");
          header.className = "log-game-header";
          header.textContent = `ç¬¬ ${gameIdx} å±€`;
          logPanelElement.appendChild(header);
        }

        function checkGameEnd() {
          const winner = checkWin(board);
          if (winner) {
            clearTimer();
            if (winner === "X") {
              handleGameWin();
            } else {
              handleGameLoss();
            }
            gameActive = false;
            highlightWinningCells(winner);
            disableAllCells();
            return true;
          }
          if (checkDraw(board)) {
            clearTimer();
            // å¹³å±€ç®—ä½œå¤±è´¥ï¼šæœ¬æ´»åŠ¨ä¸­ï¼Œå¹³å±€ä¹Ÿç®—æœªèƒ½æˆ˜èƒœ AIï¼Œä¼šæ‰£ä¸€æ¬¡æœºä¼š
            handleGameLoss();
            // å¦‚æœè¿˜æœ‰æœºä¼šï¼Œç”¨æ›´æ˜ç¡®çš„å¹³å±€æç¤ºæ–‡æ¡ˆ
            if (remainingChances > 0) {
              statusElement.textContent = `å¹³å±€äº†ï¼è¿˜æœ‰ ${remainingChances} æ¬¡æœºä¼š`;
            }
            gameActive = false;
            disableAllCells();
            return true;
          }
          return false;
        }

        function disableAllCells() {
          // æ¸¸æˆç»“æŸæ—¶ç¦ç”¨æ‰€æœ‰å•å…ƒæ ¼
          document.querySelectorAll(".cell").forEach((cell) => {
            cell.classList.add("disabled");
          });
        }

        function enableAllCells() {
          // é‡æ–°å¼€å§‹æ—¶å¯ç”¨æ‰€æœ‰å•å…ƒæ ¼
          document.querySelectorAll(".cell").forEach((cell) => {
            cell.classList.remove("disabled");
          });
        }

        function highlightWinningCells(winner) {
          // æ‰¾åˆ°è·èƒœç»„åˆï¼ˆå¤ç”¨checkWinçš„é€»è¾‘ï¼‰
          const winningCondition = findWinningCondition(winner);
          if (winningCondition) {
            const [a, b, c] = winningCondition;
            document.querySelector(
              `[data-index="${a}"]`
            ).style.backgroundColor = "#c6f6d5";
            document.querySelector(
              `[data-index="${b}"]`
            ).style.backgroundColor = "#c6f6d5";
            document.querySelector(
              `[data-index="${c}"]`
            ).style.backgroundColor = "#c6f6d5";
          }
        }

        function findWinningCondition(winner) {
          // è¾…åŠ©å‡½æ•°ï¼šæ‰¾åˆ°è·èƒœçš„ç»„åˆ
          for (let condition of winningConditions) {
            const [a, b, c] = condition;
            if (
              board[a] === winner &&
              board[a] === board[b] &&
              board[a] === board[c]
            ) {
              return condition;
            }
          }
          return null;
        }

        function minimax(currentBoard, depth, isMaximizing, maxDepth) {
          const winner = checkWin(currentBoard);
          if (winner === "O") return 10 - depth;
          if (winner === "X") return depth - 10;
          if (checkDraw(currentBoard) || depth >= maxDepth) return 0;

          if (isMaximizing) {
            let bestScore = -Infinity;
            for (let i = 0; i < 9; i++) {
              if (currentBoard[i] === "") {
                currentBoard[i] = "O";
                const score = minimax(currentBoard, depth + 1, false, maxDepth);
                currentBoard[i] = "";
                bestScore = Math.max(score, bestScore);
              }
            }
            return bestScore;
          } else {
            let bestScore = Infinity;
            for (let i = 0; i < 9; i++) {
              if (currentBoard[i] === "") {
                currentBoard[i] = "X";
                const score = minimax(currentBoard, depth + 1, true, maxDepth);
                currentBoard[i] = "";
                bestScore = Math.min(score, bestScore);
              }
            }
            return bestScore;
          }
        }

        function aiMove() {
          if (!gameActive) return;

          // ä½¿ç”¨å½“å‰æ®µä½
          let maxDepth = currentDifficulty;
          if (isNaN(maxDepth) || maxDepth < 0) maxDepth = 0;
          if (maxDepth > 5) maxDepth = 5;

          let bestMove = -1;
          if (maxDepth === 0) {
            // æ·±åº¦ä¸º0ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªç©ºä½
            const emptyCells = [];
            for (let i = 0; i < 9; i++) {
              if (board[i] === "") {
                emptyCells.push(i);
              }
            }
            if (emptyCells.length > 0) {
              // éšæœºé€‰æ‹©ä¸€ä¸ªç©ºä½
              const randomIndex = Math.floor(Math.random() * emptyCells.length);
              bestMove = emptyCells[randomIndex];
            }
          } else {
            // æ·±åº¦å¤§äº0ï¼šä½¿ç”¨minimaxç®—æ³•å‰å…ˆæ¨¡æ‹Ÿè®¡ç®—è´Ÿè½½
            simulateComputation(maxDepth);

            let bestScore = -Infinity;
            let moves = [];

            // æ”¶é›†æ‰€æœ‰ç©ºä½
            for (let i = 0; i < 9; i++) {
              if (board[i] === "") {
                moves.push(i);
              }
            }

            // éšæœºæ‰“ä¹±é¡ºåºä»¥å¢åŠ éšæœºæ€§ï¼ˆç‰¹åˆ«æ˜¯åœ¨ä½æ®µä½æ—¶ï¼‰
            shuffleArray(moves);

            // å¯»æ‰¾æœ€ä½³ç§»åŠ¨
            for (let i of moves) {
              board[i] = "O";
              const score = minimax(board, 0, false, maxDepth);
              board[i] = "";
              if (score > bestScore) {
                bestScore = score;
                bestMove = i;
              }
            }
          }

          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ€ä½³ç§»åŠ¨ï¼ˆç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼‰ï¼Œåˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªç©ºä½
          if (bestMove === -1) {
            for (let i = 0; i < 9; i++) {
              if (board[i] === "") {
                bestMove = i;
                break;
              }
            }
          }

          // æ‰§è¡ŒAIç§»åŠ¨å¹¶ç»˜åˆ¶æ£‹å­
          if (bestMove !== -1) {
            makeMove(bestMove, "O");
          }

          // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å› AIè½å­è€Œç»“æŸ
          if (!checkGameEnd()) {
            currentPlayer = "X";
            statusElement.textContent = "æ‚¨çš„å›åˆ";
            startTimer(); // ç©å®¶å›åˆå¼€å§‹å€’è®¡æ—¶
          }
        }

        // è¾…åŠ©å‡½æ•°ï¼šéšæœºæ‰“ä¹±æ•°ç»„
        function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
        }

        function nextChallenge() {
          board = ["", "", "", "", "", "", "", "", ""];
          currentPlayer = "X";
          gameActive = true;
          aiThinking = false;
          clearTimer();

          statusElement.textContent = "æ‚¨çš„å›åˆ";
          rankDisplayElement.style.display = "none";
          // Clear the thinking time display
          const thinkingTimeElement = document.getElementById("thinking-time");
          thinkingTimeElement.textContent = "";
          thinkingTimeElement.classList.remove("thinking-active");
          thinkingTimeElement.style.display = "none";
          enableAllCells();
          document.querySelectorAll(".cell").forEach((cell) => {
            cell.textContent = "";
            cell.classList.remove("x", "o");
            cell.style.backgroundColor = "";
          });
          
          nextChallengeButton.style.display = "none";
          startTimer(); // å¼€å§‹å€’è®¡æ—¶

          // æ–°çš„ä¸€å±€ï¼Œæ­¥æ•°ä» 0 å¼€å§‹è®¡æ•°å¹¶åœ¨å³ä¾§æ·»åŠ æ ‡é¢˜
          gameIndex++;
          moveNumber = 0;
          addGameHeader(gameIndex);
        }

        function startGame() {
          if (gameStarted) return;
          gameStarted = true;
          gameActive = true;
          statusElement.textContent = "æ‚¨çš„å›åˆ";
          startButton.style.display = "none";
          startTimer();

          // ç¬¬ä¸€æ¬¡å¼€å§‹æ¸¸æˆï¼Œè§†ä¸ºç¬¬ 1 å±€
          gameIndex = 1;
          moveNumber = 0;
          addGameHeader(gameIndex);
        }

         // äº‹ä»¶ç›‘å¬
        boardElement.addEventListener("click", handleCellClick);
        startButton.addEventListener("click", startGame);
        nextChallengeButton.addEventListener("click", nextChallenge);
        
        // åˆå§‹åŒ–æ¸¸æˆä¿¡æ¯æ˜¾ç¤ºï¼ˆä¸ç«‹å³å¼€å§‹å€’è®¡æ—¶ï¼Œç­‰å¾…ç©å®¶ç‚¹å‡»â€œå¼€å§‹æŒ‘æˆ˜â€ï¼‰
        updateGameInfo();
      });
    </script>
  </body>
</html>
